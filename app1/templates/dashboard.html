<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>压力管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        /* 所有之前的样式保持不变 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        body {
            display: flex;
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        /* 用户菜单容器 */
        .user-menu-container {
            position: relative;
        }

        /* 用户菜单 */
        .user-menu {
            position: absolute;
            right: 0;
            top: 100%;
            width: 200px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .user-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-menu a {
            display: block;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background 0.2s;
        }

        .user-menu a:hover {
            background: #f0f7ff;
        }

        .user-menu a i {
            margin-right: 8px;
            width: 20px;
            text-align: center;
        }

        /* 所有其他样式保持不变 */
        .sidebar {
            width: 200px;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
        }

        .user-info {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #34495e;
        }

        .nav-menu {
            flex-grow: 1;
            margin-top: 30px;
        }

        .nav-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .nav-item.active {
            background: #34495e;
            border-left: 4px solid #3498db;
        }

        .nav-item:hover {
            background: #34495e;
        }

        .main-content {
            flex-grow: 1;
            padding: 30px;
            position: relative;
        }

        .welcome-message {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 16px;
            color: #2c3e50;
        }

        .test-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            display: none;
        }

        .test-button {
            width: 30vh;
            height: 30vh;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db 0%, #1abc9c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.4);
            transition: all 0.3s;
            border: none;
        }

        .test-button:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(52, 152, 219, 0.6);
        }

        .test-button:active {
            transform: scale(0.98);
        }

        .adjust-container {
            display: none;
            height: 100%;
            padding: 30px;
        }

        .level-display {
            text-align: center;
            font-size: 24px;
            margin-bottom: 40px;
            color: #2c3e50;
        }

        .slider-container {
            width: 80%;
            max-width: 500px;
            margin: 0 auto;
        }

        .slider {
            width: 100%;
            height: 15px;
            -webkit-appearance: none;
            background: #d3d3d3;
            outline: none;
            border-radius: 10px;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        .adjust-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }

        .method-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            background: #3498db;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .method-btn:hover {
            background: #2980b9;
            transform: translateY(-3px);
        }

        .active-page {
            display: flex !important;
        }

        .logout-btn {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            margin-left: 10px;
            font-size: 16px;
            padding: 0;
            text-decoration: underline;
        }
        .logout-btn:hover {
            color: #2980b9;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            width: 80%;
            max-width: 600px;
            position: relative;
            animation: modalopen 0.4s;
        }

        @keyframes modalopen {
            from {opacity: 0; transform: translateY(-60px);}
            to {opacity: 1; transform: translateY(0);}
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }

        .close:hover {
            color: #333;
        }

        .modal-title {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .hobby-survey-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .hobby-item {
            flex-basis: calc(50% - 15px);
            background: #f5f7fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e1e5eb;
            transition: all 0.3s;
        }

        .hobby-item:hover {
            background: #e3f2fd;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .hobby-item input {
            margin-right: 10px;
        }

        .survey-submit {
            display: block;
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            margin-top: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .survey-submit:hover {
            background: #2980b9;
        }

        .test-button {
            position: relative;
            width: 30vh;
            height: 30vh;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db 0%, #1abc9c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.4);
            transition: all 0.3s;
            border: none;
        }

        .test-button:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(52, 152, 219, 0.6);
        }

        .test-button:active {
            transform: scale(0.98);
        }

        .level-display {
            text-align: center;
            font-size: 24px;
            margin-bottom: 40px;
            color: #2c3e50;
        }

        .slider-container {
            width: 80%;
            max-width: 500px;
            margin: 0 auto;
        }

        .slider {
            width: 100%;
            height: 15px;
            -webkit-appearance: none;
            background: #d3d3d3;
            outline: none;
            border-radius: 10px;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        .adjust-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }

        .method-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            background: #3498db;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .method-btn:hover {
            background: #2980b9;
            transform: translateY(-3px);
        }

        .recommendation-card {
            padding: 20px;
            border-radius: 15px;
            background: rgba(245, 247, 250, 0.7);
            border: 1px solid rgba(225, 229, 235, 0.5);
            margin-bottom: 20px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .recommendation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .recommendation-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(52, 152, 219, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #3498db;
            margin-right: 15px;
        }

        .star-rating .fa-star {
            transition: all 0.2s ease;
        }

        .star-rating .fa-star:hover,
        .star-rating .fa-star:hover ~ .fa-star {
            transform: scale(1.2);
            color: #FFD700;
        }

        .progress-bar {
            height: 8px;
            background-color: #e0e7ff;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #1abc9c);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .detection-animation {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 30px;
        }

        .circle {
            position: absolute;
            border-radius: 50%;
            border: 4px solid rgba(52, 152, 219, 0.3);
            animation: pulse 2s infinite;
        }

        .circle-1 { width: 100%; height: 100%; animation-delay: 0s; }
        .circle-2 { width: 80%; height: 80%; top: 10%; left: 10%; animation-delay: 0.2s; }
        .circle-3 { width: 60%; height: 60%; top: 20%; left: 20%; animation-delay: 0.4s; }
        .circle-4 { width: 40%; height: 40%; top: 30%; left: 30%; animation-delay: 0.6s; }

        .brain-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: #3498db;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .result-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 15px;
        }

        .result-good {
            background: rgba(26, 188, 156, 0.2);
            color: #1abc9c;
        }

        .result-medium {
            background: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
        }

        .result-bad {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            margin-top: 30px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .result-value {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            background: linear-gradient(135deg, #3498db, #1abc9c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .result-change {
            font-size: 20px;
            font-weight: bold;
            margin-top: 15px;
        }

        .change-positive {
            color: #1abc9c;
        }

        .change-negative {
            color: #e74c3c;
        }

        .recommendation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        /* 视频模态框样式 */
        #videoModal {
            transition: opacity 0.3s ease;
        }

        #videoPlayer {
            max-height: 70vh;
            background: #000;
        }


        .result-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 15px;
        }

        .result-good {
            background: rgba(26, 188, 156, 0.2);
            color: #1abc9c;
        }

        .result-medium {
            background: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
        }

        .result-bad {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-cyan-100 min-h-screen">
    <div class="min-h-screen flex flex-col">
        <!-- 顶部导航栏 -->
        <nav class="bg-white bg-opacity-90 backdrop-filter backdrop-blur-lg shadow-sm py-4 px-6">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fa fa-brain text-2xl text-blue-600"></i>
                    <span class="text-xl font-bold text-blue-800">压力管理系统</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="user-menu-container relative">
                        <button id="user-menu-button" class="flex items-center space-x-2 text-gray-700 hover:text-blue-600">
                            <i class="fa fa-user-circle text-xl"></i>
                            <span>{{ user.username }}</span>
                            <i class="fa fa-caret-down"></i>
                        </button>

                        <div id="user-menu" class="user-menu">
                            <a href="{% url 'edit_profile' %}">
                                <i class="fa fa-user"></i>个人资料
                            </a>
                            <form action="{% url 'logout' %}" method="post" style="display: inline; width: 100%;">
                                {% csrf_token %}
                                <button type="submit" style="
                                    background: none;
                                    border: none;
                                    padding: 12px 16px;
                                    color: #333;
                                    text-decoration: none;
                                    cursor: pointer;
                                    width: 100%;
                                    text-align: left;
                                    font-family: inherit;
                                    font-size: inherit;
                                    display: flex;
                                    align-items: center;
                                ">
                                    <i class="fa fa-sign-out" style="margin-right: 8px; width: 20px; text-align: center;"></i>
                                    退出登录
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 主内容区 -->
        <div class="flex-1">
            <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                <!-- 欢迎信息 -->
                <div class="mb-8 text-center">
                    <h1 class="text-3xl font-bold text-gray-800">欢迎回来，{{ user.username }}！</h1>
                    <p class="text-gray-600 mt-2">您的压力健康是我们的首要任务</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- 左侧面板 - 压力测试 -->
                    <div class="bg-white bg-opacity-80 backdrop-filter backdrop-blur-lg rounded-2xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-800">压力测试</h2>
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                                <i class="fa fa-heartbeat text-blue-600"></i>
                            </div>
                        </div>

                        <!-- 在压力测试面板内修改测试按钮部分 -->
                        <div class="text-center py-4">
                            <button id="startTest" class="test-button mx-auto">
                                开始测试
                                <span class="absolute -bottom-8 text-sm text-gray-600">请保持放松状态</span>
                            </button>

                            <!-- 添加文件上传区域 -->
                            <div id="fileUploadSection" class="mt-6 hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">上传生理信号数据(.mat)</label>
                                <div class="flex items-center justify-center">
                                    <label for="matFile" class="cursor-pointer bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
                                        <i class="fa fa-upload mr-2"></i>选择文件
                                    </label>
                                    <input type="file" id="matFile" accept=".mat" class="hidden">
                                    <span id="fileName" class="ml-3 text-sm text-gray-600">未选择文件</span>
                                </div>
                                <button id="uploadBtn" class="mt-4 w-full max-w-xs mx-auto bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <i class="fa fa-cloud-upload mr-2"></i>上传并分析
                                </button>
                            </div>
                        </div>

                        <div class="mt-8">
                            <h3 class="text-lg font-medium text-gray-700 mb-4">最近测试记录</h3>
                            <div class="space-y-3">
                                <!-- 测试记录会动态加载 -->
                                <div class="text-center py-4 text-gray-500">
                                    暂无测试记录
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 压力调节面板 -->
                    <div class="bg-white bg-opacity-80 backdrop-filter backdrop-blur-lg rounded-2xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-800">压力调节</h2>
                            <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                                <i class="fa fa-spa text-green-600"></i>
                            </div>
                        </div>

                        <div class="level-display">
                            当前压力等级: <span id="currentLevel">3</span>/5
                        </div>

                        <div class="slider-container">
                            <input type="range" min="1" max="5" value="3" class="slider" id="pressureSlider">
                        </div>

                        <div class="mt-8">
                            <h3 class="text-lg font-medium text-gray-700 mb-4">推荐调节方法</h3>
                            <div class="recommendation-grid" id="recommendationGrid">
                                <!-- 推荐内容会动态加载到这里 -->
                            </div>
                        </div>
                    </div>

                    <!-- 右侧面板 - 检测结果 -->
                    <div class="bg-white bg-opacity-80 backdrop-filter backdrop-blur-lg rounded-2xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-800">检测结果</h2>
                            <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
                                <i class="fa fa-chart-line text-purple-600"></i>
                            </div>
                        </div>

                        <div id="detectionSection">
                            <div class="detection-animation">
                                <div class="circle circle-1"></div>
                                <div class="circle circle-2"></div>
                                <div class="circle circle-3"></div>
                                <div class="circle circle-4"></div>
                                <div class="brain-icon">
                                    <i class="fa fa-brain"></i>
                                </div>
                            </div>

                            <div class="text-center">
                                <h3 class="text-lg font-medium text-gray-800 mb-4">正在检测压力水平</h3>
                                <p class="text-gray-600 mb-6">请保持放松状态，不要移动</p>

                                <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                    <div id="detectionProgress" class="h-2.5 rounded-full bg-gradient-to-r from-blue-500 to-teal-500" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div id="resultSection" class="hidden">
                            <div class="result-card">
                                <div class="text-lg font-medium text-gray-700">压力检测结果</div>
                                <div class="result-value" id="resultValue">6.2</div>
                                <div class="text-gray-600">压力等级: <span id="pressureLevelLabel">低压力</span></div>

                                <div class="mt-4">
                                    <span class="result-badge" id="resultBadge">低压力</span>
                                </div>

                                <div class="mt-6">
                                    <div class="text-sm text-gray-700 mb-2">
                                        文件名: <span id="resultFileName" class="font-medium">level1.mat</span>
                                    </div>
                                    <div class="text-sm text-gray-700 mb-2">
                                        置信度: <span id="resultConfidence" class="font-medium">0.8459</span>
                                    </div>

                                    <h4 class="font-medium text-gray-800 mt-4 mb-2">各类别概率</h4>
                                    <div class="space-y-2">
                                        <div>
                                            <div class="flex justify-between text-sm text-gray-700">
                                                <span>低压力</span>
                                                <span id="probLow">0.8459</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2 mt-1 overflow-hidden">
                                                <div id="progressLow" class="h-2 rounded-full bg-green-500" style="width: 84.59%"></div>
                                            </div>
                                        </div>

                                        <div>
                                            <div class="flex justify-between text-sm text-gray-700">
                                                <span>中压力</span>
                                                <span id="probMedium">0.0651</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2 mt-1 overflow-hidden">
                                                <div id="progressMedium" class="h-2 rounded-full bg-yellow-500" style="width: 6.51%"></div>
                                            </div>
                                        </div>

                                        <div>
                                            <div class="flex justify-between text-sm text-gray-700">
                                                <span>高压力</span>
                                                <span id="probHigh">0.0842</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2 mt-1 overflow-hidden">
                                                <div id="progressHigh" class="h-2 rounded-full bg-orange-500" style="width: 8.42%"></div>
                                            </div>
                                        </div>

                                        <div>
                                            <div class="flex justify-between text-sm text-gray-700">
                                                <span>极高压力</span>
                                                <span id="probExtreme">0.0047</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2 mt-1 overflow-hidden">
                                                <div id="progressExtreme" class="h-2 rounded-full bg-red-500" style="width: 0.47%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 历史记录图表 -->
                <div class="mt-10 bg-white bg-opacity-80 backdrop-filter backdrop-blur-lg rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">压力历史记录</h2>
                    <div class="h-64">
                        <!-- 这里可以放置压力历史图表 -->
                        <div class="bg-gray-100 border-2 border-dashed rounded-xl w-full h-full flex items-center justify-center text-gray-400">
                            压力历史图表区域
                        </div>
                    </div>
                </div>

                <!-- 视频播放模态框 -->
                <div id="videoModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
                    <div class="bg-white rounded-lg w-11/12 max-w-4xl overflow-hidden">
                        <div class="flex justify-between items-center px-4 py-3 bg-gray-100">
                            <h3 id="videoModalTitle" class="font-medium text-gray-800"></h3>
                            <button id="closeVideoModal" class="text-gray-500 hover:text-gray-700">
                                <i class="fa fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-4">
                            <video id="videoPlayer" class="w-full" controls>
                                <source id="videoSource" src="" type="video/mp4">
                                您的浏览器不支持视频播放。
                            </video>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 页脚 -->
        <footer class="py-6 bg-white bg-opacity-80 backdrop-filter backdrop-blur-lg border-t border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center text-gray-600">
                    © 2023 压力管理系统 | 关注您的心理健康
                </div>
            </div>
        </footer>
    </div>

    <script>
    // 用户信息模拟
    const userData = {
        isAuthenticated: true,
        username: "{{ user.username }}",
        latestLevel: 5
    };

    // 页面初始化
    document.addEventListener('DOMContentLoaded', () => {
        // 设置压力等级
        const pressureSlider = document.getElementById('pressureSlider');
        const currentLevel = document.getElementById('currentLevel');
        pressureSlider.value = userData.latestLevel;
        currentLevel.textContent = userData.latestLevel;

        // 初始化结果面板
        document.getElementById('resultSection').classList.add('hidden');

        // 初始化检测动画
        initDetectionAnimation();

        // 初始化用户菜单
        initUserMenu();

        // 获取开始测试按钮
        const startTestBtn = document.getElementById('startTest');

        // 添加事件监听器
        startTestBtn.addEventListener('click', () => {
        // 隐藏结果区域（如果可见）
        resultSection.classList.add('hidden');

        // 显示文件上传区域
        fileUploadSection.classList.remove('hidden');

        // 更新按钮状态
        startTestBtn.textContent = "取消测试";
        startTestBtn.disabled = false;
        });
    });

    // 初始化检测动画
    function initDetectionAnimation() {
        const circles = document.querySelectorAll('.circle');
        circles.forEach((circle, index) => {
            circle.style.animationDelay = `${index * 0.5}s`;
        });
    }

    // 初始化用户菜单
    function initUserMenu() {
        const menuButton = document.getElementById('user-menu-button');
        const userMenu = document.getElementById('user-menu');
        const menuContainer = document.querySelector('.user-menu-container');

        // 菜单显示状态
        let isMenuOpen = false;

        // 点击按钮切换菜单
        menuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            isMenuOpen = !isMenuOpen;
            userMenu.classList.toggle('active', isMenuOpen);
        });

        // 点击菜单项
        userMenu.addEventListener('click', (e) => {
            // 阻止事件冒泡，避免触发文档点击事件
            e.stopPropagation();
        });

        // 点击文档其他区域关闭菜单
        document.addEventListener('click', (e) => {
            if (isMenuOpen && !menuContainer.contains(e.target)) {
                isMenuOpen = false;
                userMenu.classList.remove('active');
            }
        });

        // 鼠标悬停在菜单容器上时保持菜单打开
        menuContainer.addEventListener('mouseenter', () => {
            isMenuOpen = true;
            userMenu.classList.add('active');
        });

        // 鼠标离开菜单容器时关闭菜单
        menuContainer.addEventListener('mouseleave', () => {
            isMenuOpen = false;
            userMenu.classList.remove('active');
        });
    }

    // 压力调节逻辑
    const pressureSlider = document.getElementById('pressureSlider');
    const currentLevel = document.getElementById('currentLevel');
    const recommendationGrid = document.getElementById('recommendationGrid');

    pressureSlider.addEventListener('input', () => {
        const stressLevel = parseInt(pressureSlider.value);
        currentLevel.textContent = stressLevel;
        getRecommendations(stressLevel);
    });

    // 获取推荐视频
    function getRecommendations(stressLevel) {
        fetch('/recommendation/recommend/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ stress_level: stressLevel })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateRecommendations(data.recommended_videos);
            } else {
                console.error('获取推荐失败:', data.error);
            }
        })
        .catch(error => console.error('请求错误:', error));
    }

    // 更新推荐显示
    function updateRecommendations(videos) {
        recommendationGrid.innerHTML = '';

        videos.forEach(video => {
            const card = document.createElement('div');
            card.className = 'recommendation-card';
            card.innerHTML = `
                <div class="flex items-start">
                    <div class="recommendation-icon">
                        <i class="fa fa-play-circle"></i>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-800 mb-1">${video.name}</h4>
                        <p class="text-sm text-gray-600">${video.description}</p>
                        <div class="mt-2">
                            <div class="flex justify-between text-sm">
                                <span>时长</span>
                                <span>${video.duration_minutes}分钟</span>
                            </div>
                        </div>
                        <button class="mt-3 px-3 py-1 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600 transition play-video-btn"
                                data-video-url="${video.video_url}"
                                data-video-title="${video.name}"
                                data-video-id="${video.id}">
                            <i class="fa fa-play mr-1"></i>播放视频
                        </button>
                    </div>
                </div>
            `;
            recommendationGrid.appendChild(card);
        });

        // 重新绑定播放按钮事件
        document.querySelectorAll('.play-video-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const videoUrl = btn.dataset.videoUrl;
                const videoTitle = btn.dataset.videoTitle;
                const videoId = btn.dataset.videoId;

                // 记录播放前的压力等级
                const preStress = parseInt(currentLevel.textContent);

                // 播放视频
                playVideo(videoId, preStress, videoTitle, videoUrl);
            });
        });
    }

    // 播放视频
    function playVideo(videoId, preStress, videoTitle, videoUrl) {
        // 设置视频源和标题
        videoSource.src = videoUrl;
        videoModalTitle.textContent = videoTitle;

        // 加载视频
        videoPlayer.load();

        // 显示模态框
        videoModal.classList.remove('hidden');

        // 视频结束后的事件处理
        videoPlayer.onended = function() {
            // 视频播放结束，弹出评分框
            const rating = prompt('请为这个视频的降压效果评分（1-5分）:');
            if (rating !== null) {
                // 用户输入了评分
                const postStress = parseInt(document.getElementById('currentLevel').textContent);

                // 获取所有推荐视频ID
                const recommendedIds = [];
                document.querySelectorAll('.play-video-btn').forEach(btn => {
                    recommendedIds.push(parseInt(btn.dataset.videoId));
                });

                // 提交反馈
                submitFeedback(preStress, postStress, parseInt(videoId), recommendedIds, parseInt(rating));

                // 更新压力等级显示
                document.getElementById('currentLevel').textContent = postStress;
                pressureSlider.value = postStress;
            }
        };
    }

    // 提交反馈
    function submitFeedback(preStress, postStress, selectedVideoId, recommendedVideoIds, rating) {
        fetch('/recommendation/feedback/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                pre_stress: preStress,
                post_stress: postStress,
                selected_video_id: selectedVideoId,
                recommended_video_ids: recommendedVideoIds,
                rating: rating
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('提交反馈失败:', data.error);
            }
        })
        .catch(error => console.error('请求错误:', error));
    }

    // 页面加载时获取初始推荐
    document.addEventListener('DOMContentLoaded', () => {
        const initialStress = parseInt(currentLevel.textContent);
        getRecommendations(initialStress);
    });

    // 爱好调查模态窗口处理
    document.addEventListener('DOMContentLoaded', () => {
        // 检查是否显示爱好调查 (模拟)
        const showHobbySurvey = false;

        if (showHobbySurvey) {
            const modal = document.getElementById('hobbySurveyModal');
            modal.style.display = 'block';

            // 关闭按钮事件
            const closeBtn = document.querySelector('.close');
            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            // 表单提交事件
            const surveyForm = document.getElementById('hobbySurveyForm');
            surveyForm.addEventListener('submit', function(e) {
                e.preventDefault();
                alert('兴趣爱好提交成功！');
                modal.style.display = 'none';
            });
        }
    });

    // 添加全局点击关闭模态窗口的功能
    window.addEventListener('click', (event) => {
        const modal = document.getElementById('hobbySurveyModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });


    // 视频播放功能
    const videoModal = document.getElementById('videoModal');
    const videoPlayer = document.getElementById('videoPlayer');
    const videoSource = document.getElementById('videoSource');
    const videoModalTitle = document.getElementById('videoModalTitle');
    const closeVideoModal = document.getElementById('closeVideoModal');

    // 播放视频按钮事件
    document.querySelectorAll('.play-video-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const videoUrl = btn.dataset.videoUrl;
            const videoTitle = btn.dataset.videoTitle;

            // 设置视频源和标题
            videoSource.src = videoUrl;
            videoModalTitle.textContent = videoTitle;

            // 加载并播放视频
            videoPlayer.load();

            // 显示模态框
            videoModal.classList.remove('hidden');
        });
    });

    // 关闭视频模态框
    closeVideoModal.addEventListener('click', () => {
        videoPlayer.pause();
        videoModal.classList.add('hidden');
    });

    // 点击模态框背景关闭
    videoModal.addEventListener('click', (e) => {
        if (e.target === videoModal) {
            videoPlayer.pause();
            videoModal.classList.add('hidden');
        }
    });


    //---------------------------
    // 获取 CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


    // 文件上传处理
    const matFileInput = document.getElementById('matFile');
    const fileNameDisplay = document.getElementById('fileName');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileUploadSection = document.getElementById('fileUploadSection');

    // 文件选择处理
    matFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            fileNameDisplay.textContent = file.name;
            uploadBtn.disabled = false;
        } else {
            fileNameDisplay.textContent = '未选择文件';
            uploadBtn.disabled = true;
        }
    });


    // 上传按钮逻辑
    uploadBtn.addEventListener('click', () => {
        const file = matFileInput.files[0];
        if (!file) return;

        // 显示检测动画
        detectionSection.classList.remove('hidden');
        fileUploadSection.classList.add('hidden');

        // 重置进度条
        detectionProgress.style.width = '0%';

        // 创建FormData对象
        const formData = new FormData();
        formData.append('mat_file', file);

        // 显示上传进度
        const progressInterval = setInterval(() => {
            const currentWidth = parseInt(detectionProgress.style.width) || 0;
            if (currentWidth < 80) {
                detectionProgress.style.width = `${currentWidth + 2}%`;
            }
        }, 100);

        // 发送文件到后端
        fetch('/upload_mat/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);

            if (data.success) {
                // 更新进度条到100%
                detectionProgress.style.width = '100%';

                setTimeout(() => {
                    // 显示结果
                    const pressureLevel = data.pressure_level;
                    const predictionLabel = data.prediction_label;
                    resultValue.textContent = pressureLevel;

                    // 更新详细结果
                    document.getElementById('resultFileName').textContent = data.file_name;
                    document.getElementById('pressureLevelLabel').textContent = predictionLabel;
                    document.getElementById('resultBadge').textContent = predictionLabel;
                    document.getElementById('resultBadge').className = `result-badge ${getPressureClass(pressureLevel)}`;
                    document.getElementById('resultConfidence').textContent = data.confidence.toFixed(4);

                    // 更新各类别概率
                    const probabilities = data.probabilities;
                    if (probabilities) {
                        document.getElementById('probLow').textContent = probabilities['低压力']?.toFixed(4) || '0.0000';
                        document.getElementById('probMedium').textContent = probabilities['中压力']?.toFixed(4) || '0.0000';
                        document.getElementById('probHigh').textContent = probabilities['高压力']?.toFixed(4) || '0.0000';
                        document.getElementById('probExtreme').textContent = probabilities['极高压力']?.toFixed(4) || '0.0000';

                        // 更新进度条
                        document.getElementById('progressLow').style.width = `${(probabilities['低压力'] || 0) * 100}%`;
                        document.getElementById('progressMedium').style.width = `${(probabilities['中压力'] || 0) * 100}%`;
                        document.getElementById('progressHigh').style.width = `${(probabilities['高压力'] || 0) * 100}%`;
                        document.getElementById('progressExtreme').style.width = `${(probabilities['极高压力'] || 0) * 100}%`;
                    }

                    // 更新UI
                    startTestBtn.textContent = "开始测试";
                    startTestBtn.disabled = false;

                    // 更新调节页面的当前等级
                    pressureSlider.value = pressureLevel;
                    currentLevel.textContent = pressureLevel;

                    // 隐藏检测动画，显示结果
                    detectionSection.classList.add('hidden');
                    resultSection.classList.remove('hidden');

                    // 保存测试结果
                    saveTestResult(pressureLevel);
                }, 500);
            } else {
                alert('文件分析失败: ' + data.error);
                resetTestState();
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            console.error('上传失败:', error);
            alert('文件上传失败，请重试');
            resetTestState();
        });
    });

    // 根据压力等级获取标签
    function getPressureLabel(level) {
        if (level <= 3) return '低压力';
        if (level <= 6) return '中压力';
        if (level <= 8) return '高压力';
        return '极高压力';
    }

    // 根据压力等级获取CSS类
    function getPressureClass(level) {
        if (level <= 3) return 'result-good';
        if (level <= 6) return 'result-medium';
        if (level <= 8) return 'result-bad';
        return 'result-bad'; // 极高压力也使用红色
    }

    // 保存测试结果函数
    function saveTestResult(pressureLevel) {
        const data = {
            pressure_level: pressureLevel,
            duration: 60 // 模拟测试持续时间
        };

        fetch('/save_test/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                console.log('测试结果保存成功');
            } else {
                console.error('保存测试结果失败:', result.error);
            }
        });
    }

    // 重置测试状态
    function resetTestState() {
        startTestBtn.textContent = "开始测试";
        startTestBtn.disabled = false;
        detectionSection.classList.add('hidden');
        fileUploadSection.classList.add('hidden');
        matFileInput.value = '';
        fileNameDisplay.textContent = '未选择文件';
        uploadBtn.disabled = true;
    }

    // 在JavaScript部分添加转换函数
    function convertTo5Level(level) {
        if (level <= 2) return 1;
        if (level <= 4) return 2;
        if (level <= 6) return 3;
        if (level <= 8) return 4;
        return 5;
    }
    // 获取推荐视频
    function getRecommendations(stressLevel) {
        const stressLevel5 = convertTo5Level(stressLevel);
        fetch('/recommendation/recommend/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ stress_level: stressLevel5 })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateRecommendations(data.recommended_videos);
            } else {
                console.error('获取推荐失败:', data.error);
            }
        })
        .catch(error => console.error('请求错误:', error));
    }

    // 更新推荐显示
    function updateRecommendations(videos) {
        const grid = document.querySelector('.recommendation-grid');
        grid.innerHTML = '';

        videos.forEach(video => {
            const card = document.createElement('div');
            card.className = 'recommendation-card';
            card.innerHTML = `
                <div class="flex items-start">
                    <div class="recommendation-icon">
                        <i class="fa fa-play-circle"></i>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-800 mb-1">${video.name}</h4>
                        <p class="text-sm text-gray-600">${video.description}</p>
                        <div class="mt-2">
                            <div class="flex justify-between text-sm">
                                <span>时长</span>
                                <span>${video.duration_minutes}分钟</span>
                            </div>
                        </div>
                        <button class="mt-3 px-3 py-1 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600 transition play-video-btn"
                                data-video-url="${video.video_url}"
                                data-video-title="${video.name}"
                                data-video-id="${video.id}">
                            <i class="fa fa-play mr-1"></i>播放视频
                        </button>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });

        // 重新绑定播放按钮事件
        document.querySelectorAll('.play-video-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const videoUrl = btn.dataset.videoUrl;
                const videoTitle = btn.dataset.videoTitle;
                const videoId = btn.dataset.videoId;

                // 播放视频
                playVideo(videoId, videoTitle, videoUrl);
            });
        });
    }

    // 提交反馈
    function submitFeedback(preStress, postStress, selectedVideoId, recommendedVideoIds, rating) {
        fetch('/recommendation/feedback/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                pre_stress: preStress,
                post_stress: postStress,
                selected_video_id: selectedVideoId,
                recommended_video_ids: recommendedVideoIds,
                rating: rating
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('提交反馈失败:', data.error);
            }
        })
        .catch(error => console.error('请求错误:', error));
    }

    // 修改播放视频函数，添加反馈提交
    function playVideo(videoId, videoTitle, videoUrl) {
        // 记录当前压力等级
        const currentStress = parseInt(document.getElementById('currentLevel').textContent);

        // 设置视频源和标题
        videoSource.src = videoUrl;
        videoModalTitle.textContent = videoTitle;

        // 加载视频
        videoPlayer.load();

        // 显示模态框
        videoModal.classList.remove('hidden');

        // 视频结束后提交反馈
        videoPlayer.onended = function() {
            // 假设压力降低1级
            const newStress = Math.max(1, currentStress - 1);

            // 获取所有推荐视频ID
            const recommendedIds = [];
            document.querySelectorAll('.play-video-btn').forEach(btn => {
                recommendedIds.push(parseInt(btn.dataset.videoId));
            });

            // 提交反馈
            submitFeedback(currentStress, newStress, parseInt(videoId), recommendedIds, 4);

            // 更新压力等级显示
            document.getElementById('currentLevel').textContent = newStress;
            pressureSlider.value = newStress;
        };
    }

    // 在压力滑块变化时获取推荐
    pressureSlider.addEventListener('input', () => {
        const stressLevel = parseInt(pressureSlider.value);
        currentLevel.textContent = stressLevel;
        getRecommendations(stressLevel);
    });

    // 页面加载时获取初始推荐
    document.addEventListener('DOMContentLoaded', () => {
        const initialStress = parseInt(currentLevel.textContent);
        getRecommendations(initialStress);
    });
</script>

</body>
</html>
