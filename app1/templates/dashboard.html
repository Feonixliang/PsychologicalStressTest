<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>压力管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        body {
            display: flex;
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        /* 侧边栏样式 */
        .sidebar {
            width: 200px;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
        }

        .user-info {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #34495e;
        }

        .nav-menu {
            flex-grow: 1;
            margin-top: 30px;
        }

        .nav-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .nav-item.active {
            background: #34495e;
            border-left: 4px solid #3498db;
        }

        .nav-item:hover {
            background: #34495e;
        }

        /* 主内容区样式 */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            position: relative;
        }

        .welcome-message {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 16px;
            color: #2c3e50;
        }

        /* 压力测试区域样式 */
        .test-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            display: none;
        }

        .test-button {
            width: 30vh;
            height: 30vh;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db 0%, #1abc9c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.4);
            transition: all 0.3s;
            border: none;
        }

        .test-button:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(52, 152, 219, 0.6);
        }

        .test-button:active {
            transform: scale(0.98);
        }

        /* 压力调节区域样式 */
        .adjust-container {
            display: none;
            height: 100%;
            padding: 30px;
        }

        .level-display {
            text-align: center;
            font-size: 24px;
            margin-bottom: 40px;
            color: #2c3e50;
        }

        .slider-container {
            width: 80%;
            max-width: 500px;
            margin: 0 auto;
        }

        .slider {
            width: 100%;
            height: 15px;
            -webkit-appearance: none;
            background: #d3d3d3;
            outline: none;
            border-radius: 10px;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        .adjust-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }

        .method-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            background: #3498db;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .method-btn:hover {
            background: #2980b9;
            transform: translateY(-3px);
        }

        /* 活动页面样式 */
        .active-page {
            display: flex !important;
        }

        .logout-btn {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            margin-left: 10px;
            font-size: 16px;
            padding: 0;
            text-decoration: underline;
        }
        .logout-btn:hover {
            color: #2980b9;
        }

        /* 爱好调查模态窗口样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            width: 80%;
            max-width: 600px;
            position: relative;
            animation: modalopen 0.4s;
        }

        @keyframes modalopen {
            from {opacity: 0; transform: translateY(-60px);}
            to {opacity: 1; transform: translateY(0);}
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }

        .close:hover {
            color: #333;
        }

        .modal-title {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .hobby-survey-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .hobby-item {
            flex-basis: calc(50% - 15px);
            background: #f5f7fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e1e5eb;
            transition: all 0.3s;
        }

        .hobby-item:hover {
            background: #e3f2fd;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .hobby-item input {
            margin-right: 10px;
        }

        .survey-submit {
            display: block;
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            margin-top: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .survey-submit:hover {
            background: #2980b9;
        }

    </style>
</head>
<body>
    <!-- 侧边导航 -->
    <div class="sidebar">
        <div class="user-info">
            <h3>压力管理系统</h3>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" data-page="test">压力测试</div>
            <div class="nav-item" data-page="adjust">压力调节</div>
        </div>
        <div class="nav-item" data-page="profile">个人资料</div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
        <!-- dashboard.html -->
        <div class="welcome-message" id="welcomeMessage">
            {% if user.is_authenticated %}
                欢迎，{{ user.username }}！
                <form method="post" action="{% url 'logout' %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" style="background: none; border: none; color: #3498db; cursor: pointer; margin-left: 10px; font-size: 16px;">
                        退出登录
                    </button>
                </form>
            {% else %}
                欢迎，游客！请先
                <a href="{% url 'login' %}" style="color: #3498db;">登录</a>
                或
                <a href="{% url 'register' %}" style="color: #3498db;">注册</a>
            {% endif %}
        </div>

        <!-- 压力测试页面 -->
        <div class="test-container active-page" id="testPage">
            <button class="test-button" id="startTest">开始测试</button>
        </div>

        <!-- 压力调节页面 -->
        <div class="adjust-container" id="adjustPage">
            <div class="level-display">
                当前压力等级: <span id="currentLevel">5</span>/10
            </div>

            <div class="slider-container">
                <input type="range" min="1" max="10" value="5" class="slider" id="pressureSlider">
            </div>

            <div class="adjust-buttons">
                <button class="method-btn" data-method="breathing">呼吸调节</button>
                <button class="method-btn" data-method="music">音乐疗法</button>
                <button class="method-btn" data-method="meditation">冥想指导</button>
                <button class="method-btn" data-method="exercise">运动建议</button>
            </div>
        </div>
    </div>


    <!-- 在<body>底部添加模态窗口 -->
    <div id="hobbySurveyModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="modal-title">兴趣爱好调查</h2>
            <p style="text-align: center; margin-bottom: 20px;">请告诉我们您的兴趣爱好，以便我们为您提供更个性化的服务</p>

            <form id="hobbySurveyForm" class="hobby-survey-form">
                {% csrf_token %}
                <div class="hobby-item">
                    <label>
                        <input type="checkbox" name="hobbies" value="reading">
                        阅读
                    </label>
                </div>

                <div class="hobby-item">
                    <label>
                        <input type="checkbox" name="hobbies" value="sports">
                        运动
                    </label>
                </div>

                <div class="hobby-item">
                    <label>
                        <input type="checkbox" name="hobbies" value="music">
                        音乐
                    </label>
                </div>

                <div class="hobby-item">
                    <label>
                        <input type="checkbox" name="hobbies" value="travel">
                        旅行
                    </label>
                </div>

                <div class="hobby-item">
                    <label>
                        <input type="checkbox" name="hobbies" value="gaming">
                        游戏
                    </label>
                </div>

                <div class="hobby-item">
                    <label>
                        <input type="checkbox" name="hobbies" value="art">
                        艺术
                    </label>
                </div>

                <div class="hobby-item">
                    <label>
                        <input type="checkbox" name="hobbies" value="cooking">
                        烹饪
                    </label>
                </div>

                <div class="hobby-item">
                    <label>
                        <input type="checkbox" name="hobbies" value="photography">
                        摄影
                    </label>
                </div>

                <div class="hobby-item">
                    <label>
                        <input type="checkbox" name="hobbies" value="dancing">
                        舞蹈
                    </label>
                </div>

                <div class="hobby-item">
                    <label>
                        <input type="checkbox" name="hobbies" value="gardening">
                        园艺
                    </label>
                </div>

                <button type="submit" class="survey-submit">提交兴趣爱好</button>
            </form>
        </div>
    </div>

    <script>
        // 用户信息模拟 (实际应从Django模板获取)
        const userData = {
            isAuthenticated: {% if user.is_authenticated %}true{% else %}false{% endif %},
            username: "{% if user.is_authenticated %}{{ user.username }}{% else %}游客{% endif %}",
            latestLevel: {% if latest_level %}{{ latest_level }}{% else %}5{% endif %}
        };

        // 页面初始化时设置压力等级
        document.addEventListener('DOMContentLoaded', () => {
            // 根据当前页面设置活动状态
            const currentPage = window.location.pathname;
            navItems.forEach(item => {
                item.classList.remove('active');
                if (currentPage.includes('edit_profile') && item.dataset.page === 'profile') {
                    item.classList.add('active');
                }
            });

            // 设置压力等级
            pressureSlider.value = userData.latestLevel;
            currentLevel.textContent = userData.latestLevel;

            // 初始化页面显示
            testPage.style.display = 'flex';
            adjustPage.style.display = 'none';
        });

        // 页面元素
        const welcomeMessage = document.getElementById('welcomeMessage');
        const testPage = document.getElementById('testPage');
        const adjustPage = document.getElementById('adjustPage');
        const navItems = document.querySelectorAll('.nav-item');
        const startTestBtn = document.getElementById('startTest');
        const pressureSlider = document.getElementById('pressureSlider');
        const currentLevel = document.getElementById('currentLevel');
        const methodBtns = document.querySelectorAll('.method-btn');

        // 导航切换
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                // 更新活动状态
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');

                // 显示对应页面
                const page = item.dataset.page;
                testPage.style.display = 'none';
                adjustPage.style.display = 'none';

                if (page === 'test') {
                    testPage.style.display = 'flex';
                } else if (page === 'adjust') {
                    adjustPage.style.display = 'flex';
                } else if (page === 'profile') {
                    // 跳转到个人资料编辑页面
                    window.location.href = "{% url 'edit_profile' %}";
                }
            });
        });


        // 压力测试逻辑
        startTestBtn.addEventListener('click', () => {
            startTestBtn.textContent = "测试中...";
            startTestBtn.disabled = true;

            // 模拟测试过程
            setTimeout(() => {
                // 随机生成压力等级 (1-10)
                const pressureLevel = Math.floor(Math.random() * 10) + 1;

                // 显示结果
                alert(`测试完成！您的压力等级为：${pressureLevel}/10`);

                // 发送数据到后端 (AJAX)
                fetch('/save_test/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        pressure_level: pressureLevel,
                        duration: 15 // 测试时间15秒
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('测试记录保存成功');
                    }
                });

                // 更新UI
                startTestBtn.textContent = "开始测试";
                startTestBtn.disabled = false;

                // 更新调节页面的当前等级
                pressureSlider.value = pressureLevel;
                currentLevel.textContent = pressureLevel;
            }, 15000); // 模拟15秒测试
        });

        // 压力调节逻辑
        pressureSlider.addEventListener('input', () => {
            currentLevel.textContent = pressureSlider.value;
        });

        // 调节方法按钮
        methodBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const method = btn.dataset.method;
                const beforeLevel = parseInt(currentLevel.textContent);

                // 模拟调节效果 (降低1-3级)
                const reduction = Math.floor(Math.random() * 3) + 1;
                let newLevel = beforeLevel - reduction;
                if (newLevel < 1) newLevel = 1;

                // 更新显示
                currentLevel.textContent = newLevel;
                pressureSlider.value = newLevel;

                // 发送数据到后端
                fetch('/save_adjustment/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        before_level: beforeLevel,
                        after_level: newLevel,
                        method: method
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('调节记录保存成功');
                        alert(`调节成功！压力等级从 ${beforeLevel} 降低到 ${newLevel}`);
                    }
                });
            });
        });

        // 获取CSRF token的函数
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        // 当页面加载完成时
        document.addEventListener('DOMContentLoaded', () => {
            // 检查是否显示爱好调查
            const showHobbySurvey = {% if show_hobby_survey %}true{% else %}false{% endif %};

            if (showHobbySurvey) {
                const modal = document.getElementById('hobbySurveyModal');
                modal.style.display = 'block';

                // 关闭按钮事件
                const closeBtn = document.querySelector('.close');
                closeBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                });

                // 表单提交事件
                const surveyForm = document.getElementById('hobbySurveyForm');
                surveyForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    // 获取选中的爱好
                    const selectedHobbies = [];
                    document.querySelectorAll('input[name="hobbies"]:checked').forEach(checkbox => {
                        selectedHobbies.push(checkbox.value);
                    });

                    // 添加CSRF令牌
                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

                    selectedHobbies.forEach(hobby => {
                        formData.append('hobbies[]', hobby);  // 添加 [] 表示数组
                    });

                    // 发送AJAX请求 - 修改后的部分
                    fetch('/save_hobby_survey/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'), // 添加CSRF令牌头
                            'Accept': 'application/json' // 明确要求JSON响应
                        },
                        body: formData
                    })

                    .then(response => {
                        // 首先检查响应状态
                        if (response.status === 403) {
                            throw new Error('CSRF验证失败');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            modal.style.display = 'none';
                            alert('兴趣爱好提交成功！感谢您的参与。');
                        } else {
                            alert('提交失败：' + (data.error || '请稍后再试'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('提交失败：' + error.message);
                    });
                });
            }
        });

        // 添加全局点击关闭模态窗口的功能
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('hobbySurveyModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

    </script>



</body>
</html>