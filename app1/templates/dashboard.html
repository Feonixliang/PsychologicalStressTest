<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>压力管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        /* 所有之前的样式保持不变 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        body {
            display: flex;
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        /* 用户菜单容器 */
        .user-menu-container {
            position: relative;
        }

        /* 用户菜单 */
        .user-menu {
            position: absolute;
            right: 0;
            top: 100%;
            width: 200px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .user-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-menu a {
            display: block;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background 0.2s;
        }

        .user-menu a:hover {
            background: #f0f7ff;
        }

        .user-menu a i {
            margin-right: 8px;
            width: 20px;
            text-align: center;
        }

        /* 所有其他样式保持不变 */
        .sidebar {
            width: 200px;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
        }

        .user-info {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #34495e;
        }

        .nav-menu {
            flex-grow: 1;
            margin-top: 30px;
        }

        .nav-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .nav-item.active {
            background: #34495e;
            border-left: 4px solid #3498db;
        }

        .nav-item:hover {
            background: #34495e;
        }

        .main-content {
            flex-grow: 1;
            padding: 30px;
            position: relative;
        }

        .welcome-message {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 16px;
            color: #2c3e50;
        }

        .test-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            display: none;
        }

        .test-button {
            width: 30vh;
            height: 30vh;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db 0%, #1abc9c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.4);
            transition: all 0.3s;
            border: none;
        }

        .test-button:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(52, 152, 219, 0.6);
        }

        .test-button:active {
            transform: scale(0.98);
        }

        .adjust-container {
            display: none;
            height: 100%;
            padding: 30px;
        }

        .level-display {
            text-align: center;
            font-size: 24px;
            margin-bottom: 40px;
            color: #2c3e50;
        }

        .slider-container {
            width: 80%;
            max-width: 500px;
            margin: 0 auto;
        }

        .slider {
            width: 100%;
            height: 15px;
            -webkit-appearance: none;
            background: #d3d3d3;
            outline: none;
            border-radius: 10px;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        .adjust-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }

        .method-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            background: #3498db;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .method-btn:hover {
            background: #2980b9;
            transform: translateY(-3px);
        }

        .active-page {
            display: flex !important;
        }

        .logout-btn {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            margin-left: 10px;
            font-size: 16px;
            padding: 0;
            text-decoration: underline;
        }
        .logout-btn:hover {
            color: #2980b9;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            width: 80%;
            max-width: 600px;
            position: relative;
            animation: modalopen 0.4s;
        }

        @keyframes modalopen {
            from {opacity: 0; transform: translateY(-60px);}
            to {opacity: 1; transform: translateY(0);}
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }

        .close:hover {
            color: #333;
        }

        .modal-title {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .hobby-survey-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .hobby-item {
            flex-basis: calc(50% - 15px);
            background: #f5f7fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e1e5eb;
            transition: all 0.3s;
        }

        .hobby-item:hover {
            background: #e3f2fd;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .hobby-item input {
            margin-right: 10px;
        }

        .survey-submit {
            display: block;
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            margin-top: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .survey-submit:hover {
            background: #2980b9;
        }

        .test-button {
            position: relative;
            width: 30vh;
            height: 30vh;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db 0%, #1abc9c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.4);
            transition: all 0.3s;
            border: none;
        }

        .test-button:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(52, 152, 219, 0.6);
        }

        .test-button:active {
            transform: scale(0.98);
        }

        .level-display {
            text-align: center;
            font-size: 24px;
            margin-bottom: 40px;
            color: #2c3e50;
        }

        .slider-container {
            width: 80%;
            max-width: 500px;
            margin: 0 auto;
        }

        .slider {
            width: 100%;
            height: 15px;
            -webkit-appearance: none;
            background: #d3d3d3;
            outline: none;
            border-radius: 10px;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        .adjust-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }

        .method-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            background: #3498db;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .method-btn:hover {
            background: #2980b9;
            transform: translateY(-3px);
        }

        .recommendation-card {
            padding: 20px;
            border-radius: 15px;
            background: rgba(245, 247, 250, 0.7);
            border: 1px solid rgba(225, 229, 235, 0.5);
            margin-bottom: 20px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .recommendation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .recommendation-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(52, 152, 219, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #3498db;
            margin-right: 15px;
        }

        .star-rating .fa-star {
            transition: all 0.2s ease;
        }

        .star-rating .fa-star:hover,
        .star-rating .fa-star:hover ~ .fa-star {
            transform: scale(1.2);
            color: #FFD700;
        }

        .progress-bar {
            height: 8px;
            background-color: #e0e7ff;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #1abc9c);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .detection-animation {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 30px;
        }

        .circle {
            position: absolute;
            border-radius: 50%;
            border: 4px solid rgba(52, 152, 219, 0.3);
            animation: pulse 2s infinite;
        }

        .circle-1 { width: 100%; height: 100%; animation-delay: 0s; }
        .circle-2 { width: 80%; height: 80%; top: 10%; left: 10%; animation-delay: 0.2s; }
        .circle-3 { width: 60%; height: 60%; top: 20%; left: 20%; animation-delay: 0.4s; }
        .circle-4 { width: 40%; height: 40%; top: 30%; left: 30%; animation-delay: 0.6s; }

        .brain-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: #3498db;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .result-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 15px;
        }

        .result-good {
            background: rgba(26, 188, 156, 0.2);
            color: #1abc9c;
        }

        .result-medium {
            background: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
        }

        .result-bad {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            margin-top: 30px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .result-value {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            background: linear-gradient(135deg, #3498db, #1abc9c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .result-change {
            font-size: 20px;
            font-weight: bold;
            margin-top: 15px;
        }

        .change-positive {
            color: #1abc9c;
        }

        .change-negative {
            color: #e74c3c;
        }

        .recommendation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        /* 视频模态框样式 */
        #videoModal {
            transition: opacity 0.3s ease;
        }

        #videoPlayer {
            max-height: 70vh;
            background: #000;
        }


        .result-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 15px;
        }

        .result-good {
            background: rgba(26, 188, 156, 0.2);
            color: #1abc9c;
        }

        .result-medium {
            background: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
        }

        .result-bad {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-cyan-100 min-h-screen">
    <div class="min-h-screen flex flex-col">
        <!-- 顶部导航栏 -->
        <nav class="bg-white bg-opacity-90 backdrop-filter backdrop-blur-lg shadow-sm py-4 px-6">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fa fa-brain text-2xl text-blue-600"></i>
                    <span class="text-xl font-bold text-blue-800">压力管理系统</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="user-menu-container relative">
                        <button id="user-menu-button" class="flex items-center space-x-2 text-gray-700 hover:text-blue-600">
                            <i class="fa fa-user-circle text-xl"></i>
                            <span>{{ user.username }}</span>
                            <i class="fa fa-caret-down"></i>
                        </button>

                        <div id="user-menu" class="user-menu">
                            <a href="{% url 'edit_profile' %}">
                                <i class="fa fa-user"></i>个人资料
                            </a>
                            <form action="{% url 'logout' %}" method="post" style="display: inline; width: 100%;">
                                {% csrf_token %}
                                <button type="submit" style="
                                    background: none;
                                    border: none;
                                    padding: 12px 16px;
                                    color: #333;
                                    text-decoration: none;
                                    cursor: pointer;
                                    width: 100%;
                                    text-align: left;
                                    font-family: inherit;
                                    font-size: inherit;
                                    display: flex;
                                    align-items: center;
                                ">
                                    <i class="fa fa-sign-out" style="margin-right: 8px; width: 20px; text-align: center;"></i>
                                    退出登录
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 主内容区 -->
        <div class="flex-1">
            <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                <!-- 欢迎信息 -->
                <div class="mb-8 text-center">
                    <h1 class="text-3xl font-bold text-gray-800">欢迎回来，{{ user.username }}！</h1>
                    <p class="text-gray-600 mt-2">您的压力健康是我们的首要任务</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- 左侧面板 - 压力测试 -->
                    <div class="bg-white bg-opacity-80 backdrop-filter backdrop-blur-lg rounded-2xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-800">压力测试</h2>
                            <div class="w-10 h-10 rounded-full bg-blue-极客100 flex items-center justify-center">
                                <i class="fa fa-heartbeat text-blue-600"></i>
                            </div>
                        </div>

                        <div class="text-center py-4">
                            <button id="startTest" class="test-button mx-auto">
                                开始测试
                                <span class="absolute -bottom-8 text-sm text-gray-600">请保持放松状态</span>
                            </button>

                            <!-- 文件上传区域 -->
                            <div id="fileUploadSection" class="mt-6 hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">上传生理信号数据(.mat)</label>
                                <div class="flex items-center justify-center">
                                    <label for="matFile" class="cursor-pointer bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
                                        <i极客 class="fa fa-upload mr-2"></i>选择文件
                                    </label>
                                    <input type="file" id="matFile" accept=".mat" class="hidden">
                                    <span id="fileName" class="ml-3 text-sm text-gray-600">未选择文件</span>
                                </div>
                                <button id="uploadBtn" class="mt-4 w-full max-w-xs mx-auto bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <i class="fa fa-cloud-upload mr-2"></i>上传并分析
                                </button>
                            </div>
                        </div>

                        <div class="mt-8">
                            <h3 class="text-lg font-medium text-gray-700 mb-4">最近测试记录</h3>
                            <div class="space-y-3" id="testRecords">
                                <div class="text-center py-4 text-gray-500">
                                    暂无测试记录
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 中间面板 - 压力调节 -->
                    <div class="bg-white bg-opacity-80 backdrop-filter backdrop-blur-lg rounded-2xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-800">压力调节</h2>
                            <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                                <i class="fa fa-spa text-green-600"></i>
                            </div>
                        </div>

                        <div class="level-display">
                            当前压力等级: <span id="currentLevel">3</span>/4
                        </div>

                        <div class="slider-container">
                            <input type="range" min="0" max="4" value="1" class="slider" id="pressureSlider">
                        </div>

                        <div class="adjust-buttons">
                            <button class="method-btn" data-method="breathing">呼吸调节</button>
                            <button class="method-btn" data-method="music">音乐疗法</button>
                            <button class="method-btn" data-method="meditation">冥想指导</button>
                        </div>

                        <div class="mt-8">
                            <h3 class="text-lg font-medium text-gray-700 mb-4">推荐调节方法</h3>
                            <div class="recommendation-grid" id="recommendationContainer">
                                <!-- 推荐内容会动态加载 -->
                            </div>
                        </div>
                    </div>

                    <!-- 右侧面板 - 检测结果 -->
                    <div class="bg-white bg-opacity-80 backdrop-filter backdrop-blur-lg rounded-2xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-800">检测结果</h2>
                            <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
                                <i class="fa fa-chart-line text-purple-600"></i>
                            </div>
                        </div>

                        <div id="detectionSection" class="hidden">
                            <div class="detection-animation">
                                <div class="circle circle-1"></div>
                                <div class="circle circle-2"></div>
                                <div class="circle circle-3"></div>
                                <div class="circle circle-4"></div>
                                <div class="brain-icon">
                                    <i class="fa fa-brain"></极客i>
                                </div>
                            </div>

                            <div class="text-center">
                                <h3 class="text-lg font-medium text-gray-800 mb-4">正在检测压力水平</h3>
                                <p class="text-gray-600 mb-6">请保持放松状态，不要移动</p>

                                <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                    <div id="detectionProgress" class="h-2.5 rounded-full bg-gradient-to-r from-blue-500 to-teal-500" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div id="resultSection" class="hidden">
                            <div class="result-card">
                                <div class="text-lg font-medium text-gray-700">压力检测结果</div>
                                <div class="result-value" id="resultValue">6.2</div>
                                <div class="text-gray-600">压力等级: <span id="pressureLevelLabel">低压力</span></div>

                                <div class="mt-4">
                                    <span class="result-badge" id="resultBadge">低压力</span>
                                </div>

                                <div class="mt-6">
                                    <div class="text-sm text-gray-700 mb-2">
                                        文件名: <span id="resultFileName" class="font-medium">level1.mat</span>
                                    </div>
                                    <div class="text-sm text-gray-700 mb-2">
                                        置信度: <span id="resultConfidence" class="font-medium">0.8459</span>
                                    </div>

                                    <h4 class="font-medium text-gray-800 mt-4 mb-2">各类别概率</h4>
                                    <div class="space-y-2">
                                        <div>
                                            <div class="flex justify-between text-sm text-gray-700">
                                                <span>低压力</span>
                                                <span id="probLow">0.8459</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2 mt-1 overflow-hidden">
                                                <div id="progressLow" class="h-2 rounded-full bg-green-500" style="width: 84.59%"></div>
                                            </div>
                                        </div>

                                        <div>
                                            <div class="flex justify-between text-sm text-gray-700">
                                                <span>中压力</span>
                                                <span id="probMedium">0.0651</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2 mt-1 overflow-hidden">
                                                <div id="progressMedium" class="h-2 rounded-full bg-yellow-500" style="width: 6.51%"></div>
                                            </div>
                                        </div>

                                        <div>
                                            <div class="flex justify-between text-sm text-gray-700">
                                                <span>高压力</span>
                                                <span id="probHigh">0.0842</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2 mt-1 overflow-hidden">
                                                <div id="progressHigh" class="h-2 rounded-full bg-orange-500" style="width: 8.42%"></div>
                                            </div>
                                        </div>

                                        <div>
                                            <div class="flex justify-between text-sm text-gray-700">
                                                <span>极高压力</span>
                                                <span id="probExtreme">0.0047</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2 mt-1 overflow-hidden">
                                                <div id="progressExtreme" class="h-2 rounded-full bg-red-500" style="width: 0.47%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 历史记录图表 -->
                <div class="mt-10 bg-white bg-opacity-80 backdrop-filter backdrop-blur-lg rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">压力历史记录</h2>
                    <div class="h-64">
                        <div class="bg-gray-100 border-2 border-dashed rounded-xl w-full h-full flex items-center justify-center text-gray-400">
                            压力历史图表区域
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 页脚 -->
        <footer class="py-6 bg-white bg-opacity-80 backdrop-filter backdrop-blur-lg border-t border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center text-gray-600">
                    © 2023 压力管理系统 | 关注您的心理健康
                </div>
            </div>
        </footer>
    </div>

    <!-- 视频播放模态框 -->
    <div id="videoModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg w-11/12 max-w-4xl overflow-hidden">
            <div class="flex justify-between items-center px-4 py-3 bg-gray-100">
                <h3 id="videoModalTitle" class="font-medium text-gray-800"></h3>
                <button id="closeVideoModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <video id="videoPlayer" class="w-full" controls>
                    <source id="videoSource" src="" type="video/mp4">
                    您的浏览器不支持视频播放。
                </video>
            </div>
        </div>
    </div>

    <div id="feedbackModal" class="modal hidden">
      <div class="modal-content">
        <h3>请提供反馈</h3>
        <p>观看视频后您的压力变化：</p>
        <div class="feedback-sliders">
          <label>观看前压力: <span id="preStressValue">3</span></label>
          <input type="range" min="1" max="5" value="3" id="preStressSlider">

          <label>观看后压力: <span id="postStressValue">2</span></label>
          <input type="range" min="1" max="5" value="2" id="postStressSlider">
        </div>
        <button id="submitFeedback">提交反馈</button>
      </div>
    </div>

    <script>
    // ================== 全局状态和配置 ==================
    const userData = {
        isAuthenticated: true,
        username: "{{ user.username }}",
        latestLevel: 3
    };

    // ================== DOM元素引用 ==================
    const domRefs = {
        pressureSlider: document.getElementById('pressureSlider'),
        currentLevel: document.getElementById('currentLevel'),
        startTestBtn: document.getElementById('startTest'),
        detectionProgress: document.getElementById('detectionProgress'),
        detectionSection: document.getElementById('detectionSection'),
        resultSection: document.getElementById('resultSection'),
        resultValue: document.getElementById('resultValue'),
        matFileInput: document.getElementById('matFile'),
        fileNameDisplay: document.getElementById('fileName'),
        uploadBtn: document.getElementById('uploadBtn'),
        fileUploadSection: document.getElementById('fileUploadSection'),
        videoModal: document.getElementById('videoModal'),
        videoPlayer: document.getElementById('videoPlayer'),
        videoSource: document.getElementById('videoSource'),
        videoModalTitle: document.getElementById('videoModalTitle'),
        testRecords: document.getElementById('testRecords'),
        recommendationContainer: document.getElementById('recommendationContainer')
    };

    // ================== 初始化函数 ==================
    function initApp() {
        // 设置压力等级
        domRefs.pressureSlider.value = userData.latestLevel;
        domRefs.currentLevel.textContent = userData.latestLevel;

        // 初始化事件监听
        initEventListeners();

        // 加载推荐内容
        loadRecommendations();

        // 加载测试记录
        loadTestRecords();
    }

    // ================== 事件监听器初始化 ==================
    function initEventListeners() {
        // 压力滑块事件
        domRefs.pressureSlider.addEventListener('input', () => {
            domRefs.currentLevel.textContent = domRefs.pressureSlider.value;
        });

        // 开始测试按钮
        domRefs.startTestBtn.addEventListener('click', handleStartTest);

        // 文件上传处理
        domRefs.matFileInput.addEventListener('change', handleFileSelect);
        domRefs.uploadBtn.addEventListener('click', handleFileUpload);

        // 调节方法按钮
        document.querySelectorAll('.method-btn').forEach(btn => {
            btn.addEventListener('click', handleMethodSelection);
        });

        // 视频模态框关闭
        document.getElementById('closeVideoModal').addEventListener('click', closeVideoModal);
        domRefs.videoModal.addEventListener('click', (e) => {
            if (e.target === dom极客Refs.videoModal) closeVideoModal();
        });

        // 用户菜单
        initUserMenu();
    }

    // ================== 核心功能函数 ==================
    function handleStartTest() {
        // 隐藏结果区域
        domRefs.resultSection.classList.add('hidden');

        // 显示文件上传区域
        domRefs.fileUploadSection.classList.remove('hidden');

        // 更新按钮状态
        domRefs.startTestBtn.textContent = "取消测试";
    }

    function handleFileSelect(e) {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            domRefs.fileNameDisplay.textContent = file.name;
            domRefs.uploadBtn.disabled = false;
        } else {
            domRefs.fileNameDisplay.textContent = '未选择文件';
            domRefs.uploadBtn.disabled = true;
        }
    }

    function handleFileUpload() {
        const file = domRefs.matFileInput.files[0];
        if (!file) return;

        // 显示检测动画
        domRefs.detectionSection.classList.remove('hidden');
        domRefs.fileUploadSection.classList.add('hidden');

        // 重置进度条
        domRefs.detectionProgress.style.width = '0%';

        // 创建FormData对象
        const formData = new FormData();
        formData.append('mat_file', file);

        // 显示上传进度
        const progressInterval = setInterval(() => {
            const currentWidth = parseInt(domRefs.detectionProgress.style.width) || 0;
            if (currentWidth < 80) {
                domRefs.detectionProgress.style.width = `${currentWidth + 2}%`;
            }
        }, 100);

        // 发送文件到后端
        fetch('/upload_mat/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);

            if (data.success) {
                // 更新进度条到100%
                domRefs.detectionProgress.style.width = '100%';

                setTimeout(() => {
                    // 显示结果
                    const pressureLevel = data.pressure_level;
                    const predictionLabel = data.prediction_label;
                    domRefs.resultValue.textContent = pressureLevel;

                    // 更新详细结果
                    document.getElementById('resultFileName').textContent = data.file_name;
                    document.getElementById('pressureLevelLabel').textContent = predictionLabel;
                    document.getElementById('resultBadge').textContent = predictionLabel;
                    document.getElementById('resultBadge').className = `result-badge ${getPressureClass(pressureLevel)}`;
                    document.getElementById('resultConfidence').textContent = data.confidence.toFixed(4);

                    // 更新各类别概率
                    const probabilities = data.probabilities;
                    if (probabilities) {
                        document.getElementById('probLow').textContent = probabilities['低压力']?.toFixed(4) || '0.0000';
                        document.getElementById('probMedium').textContent = probabilities['中压力']?.toFixed(4) || '0.0000';
                        document.getElementById('probHigh').textContent = probabilities['高压力']?.toFixed(4) || '0.0000';
                        document.getElementById('probExtreme').textContent = probabilities['极高压力']?.toFixed(4) || '0.0000';

                        // 更新进度条
                        document.getElementById('progressLow').style.width = `${(probabilities['低压力'] || 0) * 100}%`;
                        document.getElementById('progressMedium').style.width = `${(probabilities['中压力'] || 0) * 100}%`;
                        document.getElementById('progressHigh').style.width = `${(probabilities['高压力'] || 0) * 100}%`;
                        document.getElementById('progressExtreme').style.width = `${(probabilities['极高压力'] || 0) * 100}%`;
                    }

                    // 更新UI
                    domRefs.startTestBtn.textContent = "开始测试";
                    domRefs.startTestBtn.disabled = false;

                    // 更新调节页面的当前等级
                    domRefs.pressureSlider.value = pressureLevel;
                    domRefs.currentLevel.textContent = pressureLevel;

                    // 隐藏检测动画，显示结果
                    domRefs.detectionSection.classList.add('hidden');
                    domRefs.resultSection.classList.remove('hidden');

                    // 保存测试结果
                    saveTestResult(pressureLevel);

                    // 重新加载推荐内容
                    loadRecommendations();
                }, 500);

            } else {
                alert('文件分析失败: ' + data.error);
                resetTestState();
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            console.error('上传失败:', error);
            alert('文件上传失败，请重试');
            resetTestState();
        });
    }

    function handleMethodSelection(e) {
        const method = e.target.dataset.method;
        const beforeLevel = parseInt(domRefs.currentLevel.textContent);

        // 模拟调节效果
        const reduction = Math.floor(Math.random() * 2) + 1;
        let newLevel = beforeLevel - reduction;
        if (newLevel < 1) newLevel = 1;

        // 更新显示
        domRefs.currentLevel.textContent = newLevel;
        domRefs.pressureSlider.value = newLevel;

        // 显示通知
        showNotification(`使用${getMethodName(method)}成功！压力等级从 ${beforeLevel} 降低到 ${newLevel}`);

        // 保存调节记录
        saveAdjustmentRecord(beforeLevel, newLevel, method);
    }

    // ================== 后端API交互函数 ==================
    function saveTestResult(pressureLevel) {
        const data = {
            pressure_level: pressureLevel,
            duration: 60 // 模拟测试持续时间
        };

        fetch('/save_test/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                console.log('测试结果保存成功');
                // 重新加载测试记录
                loadTestRecords();
            } else {
                console.error('保存测试结果失败:', result.error);
            }
        });
    }

    function saveAdjustmentRecord(beforeLevel, afterLevel, method) {
        const data = {
            before_level: beforeLevel,
            after_level: afterLevel,
            method: method
        };

        fetch('/save_adjustment/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                console.log('调节记录保存成功');
            } else {
                console.error('保存调节记录失败:', result.error);
            }
        });
    }

    function loadTestRecords() {
        // 从后端获取测试记录
        fetch('/get_test_records/') // 需要添加这个URL到urls.py
        .then(response => response.json())
        .then(data => {
            if (data.success && data.records) {
                domRefs.testRecords.innerHTML = '';

                data.records.forEach(record => {
                    const recordElement = `
                        <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center">
                            <div>
                                <div class="font-medium">${record.date}</div>
                                <div class="text-sm text-gray-500">${record.duration}</div>
                            </div>
                            <span class="result-badge ${getPressureClass(record.level)}">${record.level}</span>
                        </div>
                    `;
                    domRefs.testRecords.innerHTML += recordElement;
                });
            }
        });
    }

    function loadRecommendations() {
        // 从后端获取推荐内容
        fetch('/get_recommendations/')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.recommended_videos) {
                domRefs.recommendationContainer.innerHTML = '';

                data.recommended_videos.forEach(video => {
                    const videoCard = `
                        <div class="recommendation-card">
                            <div class="flex items-start">
                                <div class="recommendation-icon">
                                    <i class="fa fa-play-circle"></i>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-800 mb-1">${video.name}</h4>
                                    <p class="text-sm text-gray-600">${video.description}</p>
                                    <div class="mt-2">
                                        <div class="flex justify-between text-sm">
                                            <span>时长</span>
                                            <span>${video.duration_minutes}分钟</span>
                                        </div>
                                    </div>
                                    <button class="mt-3 px-3 py-1 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600 transition play-video-btn"
                                            data-video-url="${video.video_url}"
                                            data-video-title="${video.name}">
                                        <i class="fa fa-play mr-1"></i>播放视频
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    domRefs.recommendationContainer.innerHTML += videoCard;
                });

                // 绑定新创建的播放按钮
                document.querySelectorAll('.play-video-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const videoUrl = btn.dataset.videoUrl;
                        const videoTitle = btn.dataset.videoTitle;
                        playVideo(videoUrl, videoTitle);
                    });
                });
            }
        });
    }

    // ================== 工具函数 ==================
    function getPressureLabel(level) {
        if (level <= 3) return '低压力';
        if (level <= 6) return '中压力';
        if (level <= 8) return '高压力';
        return '极高压力';
    }

    function getPressureClass(level) {
        if (level <= 3) return 'result-good';
        if (level <= 6) return 'result-medium';
        if (level <= 8) return 'result-bad';
        return 'result-bad';
    }

    function getMethodName(method) {
        const methods = {
            'breathing': '呼吸调节',
            'music': '音乐疗法',
            'meditation': '冥想指导'
        };
        return methods[method] || method;
    }

    function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    function playVideo(url, title) {
        domRefs.videoSource.src = url;
        domRefs.videoModalTitle.textContent = title;
        domRefs.videoPlayer.load();
        domRefs.videoModal.classList.remove('hidden');
    }

    function closeVideoModal() {
        domRefs.videoPlayer.pause();
        domRefs.videoModal.classList.add('hidden');
    }

    function initUserMenu() {
        const menuButton = document.getElementById('user-menu-button');
        const userMenu = document.getElementById('user-menu');
        const menuContainer = document.querySelector('.user-menu-container');

        let isMenuOpen = false;

        menuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            isMenuOpen = !isMenuOpen;
            userMenu.classList.toggle('active', isMenuOpen);
        });

        document.addEventListener('click', (e) => {
            if (isMenuOpen && !menuContainer.contains(e.target)) {
                isMenuOpen = false;
                userMenu.classList.remove('active');
            }
        });

        menuContainer.addEventListener('mouseenter', () => {
            isMenuOpen = true;
            userMenu.classList.add('active');
        });

        menuContainer.addEventListener('mouseleave', () => {
            isMenuOpen = false;
            userMenu.classList.remove('active');
        });
    }

    function resetTestState() {
        domRefs.startTestBtn.textContent = "开始测试";
        domRefs.startTestBtn.disabled = false;
        domRefs.detectionSection.classList.add('hidden');
        domRefs.fileUploadSection.classList.add('hidden');
        domRefs.matFileInput.value = '';
        domRefs.fileNameDisplay.textContent = '未选择文件';
        domRefs.uploadBtn.disabled = true;
    }

    // 获取 CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


    // 反馈提交处理
    document.getElementById('submitFeedback').addEventListener('click', () => {
      const preStress = parseInt(document.getElementById('preStressSlider').value);
      const postStress = parseInt(document.getElementById('postStressSlider').value);
      const selectedVideoId = currentVideoId; // 当前播放的视频ID

      fetch('/submit_feedback/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          pre_stress: preStress,
          post_stress: postStress,
          selected_video_id: selectedVideoId
        })
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          alert('感谢您的反馈！');
          closeFeedbackModal();
        }
      });
    });


    // ================== 启动应用 ==================
    document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
